<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
    }

    .container {
      width: 80%;
      max-width: 600px;
    }

    input,
    textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      margin-top: 8px;
    }

    button {
      width: 100%;
      padding: 10px;
      border: none;
      color: white;
      background-color: green;
      cursor: pointer;
      font-size: 16px;
    }

    button:active {
      color: black;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    .response,
    .prompt,
    .aiResp {
      font-size: 11px;
      padding: 8px;
    }

    .prompt {
      background-color: pink;
    }

    .aiResp {
      background-color: lightblue;
    }

    #responseParsed {
      font-size: 11px;
    }

    #models {
      margin-top: 10px;
      height: 35px;
      outline: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <select id="models"></select><h1>AI Chat</h1>
    <p id="responseParsed"></p>
    <label for="prompt">Enter your prompt here</label>
    <textarea id="prompt" placeholder="Enter your prompt here" rows="4" aria-label="Prompt"></textarea>
    <button onclick="generateCode()" id="generateCodeBtn" aria-label="Generate Code">Generate Code</button>
    <h3>Raw Response From AI</h3>
    <textarea id="response" readonly rows="4" aria-label="Raw Response"></textarea>
    <h3>History</h3>
    <table id="history" role="table"></table>
    <p id="renderedResp"></p>
  </div>
  <script>
    function $(selector) {
      return document.querySelector(selector);
    }
    function _(tag) {
      return document.createElement(tag);
    }
    async function populateModelsDropDown() {
      const modelsResp = await fetch('/models', {
        method: 'GET'
      });
      console.log("modelsResp", modelsResp);
      const reader = modelsResp.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let result;
      let chunk = "";
      while (!result || !result.done) {
        result = await reader.read();
        chunk += decoder.decode(result.value || new Uint8Array, { stream: !result.done });
      }
      let models = JSON.parse(chunk);
      console.log("chunk",models);
      let sel = $("#models");
      if(models) {
        for(let modelIndx=0;modelIndx<models.length;modelIndx++) {
          let opt = _("option");
          opt.innerText = models[modelIndx];
          opt.value = models[modelIndx];
          sel.appendChild(opt);
        }
      }
    }
    populateModelsDropDown();
    const responseArea = $('#response');
    const responseAreaParsed = $('#responseParsed');
    const renderedResp = $('#renderedResp');
    let lastPrompt = "";
    async function generateCode() {
      const prompt = $('#prompt').value.trim();
      if (prompt == "") {
        alert("Enter The Prompt");
        return;
      }
      responseArea.value = '';
      if (responseAreaParsed.innerText != '') {
        let table = $("#history");
        let tr0 = _("tr");
        let tr1 = _("tr");
        let td00 = _("td");
        let td11 = _("td");
        td00.setAttribute("class", "prompt");
        td00.innerText = lastPrompt;
        td11.setAttribute("class", "aiResp");
        td11.innerText = responseAreaParsed.innerText;
        table.appendChild(tr0);
        table.appendChild(tr1);
        tr0.appendChild(td00);
        tr1.appendChild(td11);
      }
      lastPrompt = prompt;
      responseAreaParsed.innerText = '';

      const response = await fetch('/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ prompt: prompt, model: $("#models").value })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let result;

      while (!result || !result.done) {
        result = await reader.read();
        const chunk = decoder.decode(result.value || new Uint8Array, { stream: !result.done });
        responseArea.value += chunk;
        try {
          let chunkObj = JSON.parse(chunk);
          //console.log(chunkObj.response);
          responseAreaParsed.innerText += chunkObj.response;
          if (responseAreaParsed.innerText.indexOf("<html") > -1) {
            let html = responseAreaParsed.innerText;
            html = html.substring(html.indexOf("<html"));
            if (html.indexOf("```") > -1) {
              html = html.substring(0, html.indexOf("```"));
              let START_WORD = '<' + 'script' + '>';
              let start = html.indexOf(START_WORD);
              let END_WORD = '<' + '/script' + '>';
              let end = html.indexOf(END_WORD);
              if (start > -1 && end > -1) {
                let scriptStr = html.substring(start + START_WORD.length);
                scriptStr = scriptStr.substring(0, scriptStr.indexOf(END_WORD));
                console.log("injected script", scriptStr);
                let script = _("script");
                script.type = 'text/javascript';
                script.text = scriptStr;
                document.body.appendChild(script);
              }
            }
            renderedResp.innerHTML = html;
          } else {
            renderedResp.innerHTML = "";
          }
        } catch (e) {
          console.log(e);
        }
      }
    }
  </script>
</body>

</html>